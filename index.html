<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crazy Pro Mini App v2 - Final Version</title>

    <!-- Dependencies -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
    
    <!-- Your MoniTag Zone IDs are correctly placed here -->
    <script src='//libtl.com/sdk.js' data-zone='10033704' data-sdk='show_10033704'></script>
    <script src='//libtl.com/sdk.js' data-zone='10103622' data-sdk='show_10103622'></script>
    <script src='//libtl.com/sdk.js' data-zone='10103569' data-sdk='show_10103569'></script>
    <script src='//libtl.com/sdk.js' data-zone='10103627' data-sdk='show_10103627'></script>
    <script src='//libtl.com/sdk.js' data-zone='10103633' data-sdk='show_10103633'></script>

    <style>
        /* CSS styles are complete and require no changes */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        :root {
            --bg-gradient: linear-gradient(135deg, #121212, #1a1a2e); --primary-color: rgba(44, 44, 64, 0.7);
            --secondary-color: rgba(30, 30, 50, 0.8); --accent-color: #e94560; --auto-btn-color: #3498db;
            --text-color: #f0f0f0; --glow-color: rgba(233, 69, 96, 0.6); --green-color: rgba(46, 204, 113, 0.2);
            --yellow-color: rgba(241, 196, 15, 0.2); --red-color: rgba(231, 76, 60, 0.2);
        }
        body {
            font-family: 'Roboto', sans-serif; background: var(--bg-gradient); color: var(--text-color);
            margin: 0; padding: 15px; overflow-x: hidden; -webkit-user-select: none; user-select: none;
        }
        .container { display: flex; flex-direction: column; gap: 15px; }
        .card {
            background-color: var(--primary-color); border-radius: 15px; padding: 20px;
            border: 1px solid var(--secondary-color); box-shadow: 0 4px 25px rgba(0, 0, 0, 0.5); backdrop-filter: blur(10px);
        }
        .card h4 { display: flex; align-items: center; gap: 10px; margin-top: 0; }
        .profile-card { display: flex; align-items: center; gap: 15px; padding: 15px; }
        .profile-pic {
            width: 60px; height: 60px; border-radius: 50%; border: 2px solid var(--accent-color);
            object-fit: cover; animation: pulse-glow 3s infinite ease-in-out;
        }
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 5px var(--glow-color); } 50% { box-shadow: 0 0 20px var(--glow-color); } }
        .profile-pic .icon { font-size: 30px; text-align: center; line-height: 56px; color: var(--accent-color); }
        .profile-info h3 { margin: 0; font-size: 1.4rem; }
        .task-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .btn {
            color: white; border: none; padding: 15px; border-radius: 12px; font-size: 1rem; font-weight: 600;
            cursor: pointer; transition: all 0.2s ease-out; position: relative; overflow: hidden;
        }
        .manual-btn { background-image: linear-gradient(45deg, var(--accent-color), #f06a81); box-shadow: 0 4px 15px var(--glow-color); }
        .btn:hover:not(:disabled) { transform: translateY(-3px) scale(1.02); filter: brightness(1.1); }
        .btn:active:not(:disabled) { transform: translateY(-1px) scale(0.98); filter: brightness(0.9); }
        .btn:disabled { background: #555; cursor: not-allowed; box-shadow: none; opacity: 0.6; }
        .progress-bar { position: absolute; bottom: 0; left: 0; height: 4px; background-color: white; width: 0%; transition: width 0.5s ease; }
        .network-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .info-item { background-color: var(--secondary-color); padding: 12px; border-radius: 10px; display: flex; align-items: center; gap: 10px; font-size: 0.9rem; }
        .info-item i { color: var(--accent-color); font-size: 1.2rem; width: 20px; text-align: center; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; }
        .stat-item { text-align: center; }
        .stat-item .value { font-size: 2rem; font-weight: 700; color: var(--accent-color); }
        .history-list { list-style: none; padding: 0; margin-top: 15px; max-height: 180px; overflow-y: auto; }
        .history-list li { padding: 10px 15px; margin-bottom: 8px; border-radius: 8px; display: flex; justify-content: space-between; border-left: 5px solid; }
        .ip-green { background-color: var(--green-color); border-color: #2ecc71; }
        .ip-yellow { background-color: var(--yellow-color); border-color: #f1c40f; }
        .ip-red { background-color: var(--red-color); border-color: #e74c3c; }
        .actions-card { display: flex; gap: 15px; }
        .actions-card .btn { flex-grow: 1; background-image: none; background-color: var(--secondary-color); }
    </style>
</head>
<body>
    <div class="container" id="app-container">
        
        <div class="card profile-card">
            <div class="profile-pic" id="profile-pic-container"></div>
            <div class="profile-info"><h3 id="user-name">Loading...</h3></div>
        </div>
        
        <div class="card" id="task-card">
            <h4 style="display: flex; justify-content: space-between; align-items: center;">
                <span><i class="fas fa-tasks"></i> Watch Ads</span>
                <span style="font-size: 0.8rem; font-weight: 400; opacity: 0.8;" id="clicks-to-next-zone"></span> 
            </h4>
            <div class="task-grid">
                <button class="btn manual-btn" id="video-ad-btn"><i class="fas fa-video"></i> Video <span id="video-count-text"></span><div class="progress-bar" id="video-progress"></div></button>
                <button class="btn manual-btn" id="web-visit-btn"><i class="fas fa-globe"></i> Web Visit <span id="web-count-text"></span><div class="progress-bar" id="web-progress"></div></button>
            </div>
        </div>

        <div class="card" id="network-card">
            <h4><i class="fas fa-wifi"></i> Network Information</h4>
            <div class="network-info-grid" id="network-info-grid">
                <div class="info-item"><i class="fas fa-network-wired"></i> <span id="ip-address">Loading...</span></div>
                <div class="info-item"><i class="fas fa-signal"></i> <span id="connection-type">Loading...</span></div>
                <div class="info-item"><i class="fas fa-flag"></i> <span id="country">Loading...</span></div>
                <div class="info-item"><i class="fas fa-map-marker-alt"></i> <span id="region">Loading...</span></div>
                <div class="info-item" style="grid-column: 1 / -1;"><i class="fas fa-bullseye"></i> <span id="active-zone">Loading...</span></div>
                <div class="info-item" style="grid-column: 1 / -1;"><i class="fas fa-broadcast-tower"></i> <span id="isp">Loading...</span></div>
            </div>
            <button class="btn manual-btn" id="retry-btn" style="display: none; margin-top: 15px;">
                <i class="fas fa-sync-alt"></i> Retry Connection
            </button>
        </div>
        
        <div class="card" id="stats-card"><h4><i class="fas fa-chart-line"></i> Click Statistics</h4><div class="stats-grid"><div class="stat-item"><div class="value" id="today-clicks">0</div><div>Today</div></div><div class="stat-item"><div class="value" id="week-clicks">0</div><div>7 Days</div></div><div class="stat-item"><div class="value" id="month-clicks">0</div><div>30 Days</div></div><div class="stat-item"><div class="value" id="total-clicks">0</div><div>Total</div></div></div></div>
        <div class="card" id="chart-card"><h4><i class="fas fa-chart-area"></i> Click Graph (Last 30 Days)</h4><canvas id="click-chart"></canvas></div>
        <div class="card" id="history-card"><h4><i class="fas fa-history"></i> IP History (Last 10)</h4><ul class="history-list" id="ip-history-list"></ul></div>
        <div class="card actions-card"><button class="btn" id="send-report-btn"><i class="fas fa-paper-plane"></i> Send Report</button><button class="btn" id="reset-data-btn"><i class="fas fa-sync-alt"></i> Reset Data</button></div>
    </div>
    
    <audio id="click-sound" src="https://www.soundjay.com/buttons/sounds/button-16.mp3" preload="auto"></audio>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tg = window.Telegram.WebApp;
            
            // --- Configuration Section (All your details are set) ---
            const isTaskOn = true;
            const MAX_VIDEO_ADS = 25;
            const MAX_WEB_VISITS = 25;
            const BOT_TOKEN = '8073679681:AAEVL3KwJYdHkznDnaF0638mG3iq150wDfQ'; 
            const ADMIN_CHAT_ID = '6840260543';
            const adZoneIds = ['10033704', '10103622', '10103569', '10103627', '10103633'];
            const AD_LOAD_TIMEOUT = 15000; // 15 seconds

            // --- State and Elements (No changes needed here) ---
            let userIP = 'unknown_ip';
            let appData = { ipHistory: [], clickHistory: [], videoAdCount: 0, webVisitCount: 0, clickRotationCounter: 0 };
            const elements = {
                userName: document.getElementById('user-name'), profilePic: document.getElementById('profile-pic-container'), ipAddress: document.getElementById('ip-address'), connectionType: document.getElementById('connection-type'), country: document.getElementById('country'), region: document.getElementById('region'), isp: document.getElementById('isp'), todayClicks: document.getElementById('today-clicks'), weekClicks: document.getElementById('week-clicks'), monthClicks: document.getElementById('month-clicks'), totalClicks: document.getElementById('total-clicks'), videoAdBtn: document.getElementById('video-ad-btn'), webVisitBtn: document.getElementById('web-visit-btn'),
                ipHistoryList: document.getElementById('ip-history-list'), resetDataBtn: document.getElementById('reset-data-btn'), sendReportBtn: document.getElementById('send-report-btn'), clickSound: document.getElementById('click-sound'),
                retryBtn: document.getElementById('retry-btn'),
                networkInfoGrid: document.getElementById('network-info-grid')
            };

            // --- Initialization ---
            function initializeApp() {
                tg.ready(); tg.expand(); tg.enableClosingConfirmation();
                loadData();
                setupUserInfo();
                updateAllUI();
                setupEventListeners();
                applyCrazyAnimations();
                setTimeout(() => {
                    fetchNetworkAndLocationInfo();
                }, 1000);
            }

            // --- Data Handling ---
            function saveData() { localStorage.setItem('proCrazyAppDataV2', JSON.stringify(appData)); }
            function loadData() { const savedData = localStorage.getItem('proCrazyAppDataV2'); if (savedData) appData = JSON.parse(savedData); }
            
            async function fetchNetworkAndLocationInfo() {
                elements.networkInfoGrid.style.display = 'grid';
                elements.retryBtn.style.display = 'none';
                elements.ipAddress.textContent = "Fetching...";
                elements.connectionType.textContent = "Fetching...";
                
                try {
                    const ipResponse = await fetch('https://api.ipify.org?format=json');
                    const ipData = await ipResponse.json();
                    userIP = ipData.ip;
                    elements.ipAddress.textContent = userIP;

                    const connection = navigator.connection;
                    if (connection && connection.type === 'wifi') {
                        elements.connectionType.textContent = 'Wi-Fi';
                    } else if (connection && (connection.type === 'cellular' || connection.type.includes('g'))) {
                        elements.connectionType.textContent = 'Mobile Data';
                    } else {
                        elements.connectionType.textContent = 'Wi-Fi';
                    }

                    const locationInfo = await getLocationFromIP(userIP);
                    elements.country.textContent = locationInfo.country;
                    elements.region.textContent = locationInfo.region;
                    elements.isp.textContent = locationInfo.isp;
                    handleNewIP();
                } catch (error) {
                    console.error('Failed to fetch IP/Location:', error);
                    elements.networkInfoGrid.style.display = 'none';
                    elements.retryBtn.style.display = 'block';
                    userIP = "unknown_ip";
                }
            }
            
            async function getLocationFromIP(ip) { try { const response = await fetch(`https://ipapi.co/${ip}/json/`); const data = await response.json(); if (data.error) throw new Error(data.reason); return { country: data.country_name || 'N/A', region: data.region || 'N/A', isp: data.org || 'N/A' }; } catch (error) { console.error('Location fetch failed:', error); return { country: 'Unknown', region: 'Unknown', isp: 'Unknown' }; } }
            
            function handleNewIP() {
                if (userIP === 'unknown_ip') return;
                let currentIpData = appData.ipHistory.find(ip => ip.ip === userIP); if (!currentIpData) { currentIpData = { ip: userIP, clicks: 0, visitCount: 1 }; appData.ipHistory.unshift(currentIpData); if (appData.ipHistory.length > 10) appData.ipHistory.pop(); appData.videoAdCount = 0; appData.webVisitCount = 0; tg.HapticFeedback.notificationOccurred('success'); tg.showAlert('New IP Detected! Tasks have been reset.'); } else { currentIpData.visitCount++; } currentIpData.lastSeen = Date.now(); saveData();
            }
            function recordClick() { let ipData = appData.ipHistory.find(ip => ip.ip === userIP); if (!ipData) { ipData = { ip: userIP, clicks: 0, visitCount: 1 }; appData.ipHistory.unshift(ipData); } ipData.clicks++; const today = new Date().toISOString().split('T')[0]; let todayEntry = appData.clickHistory.find(entry => entry.date === today); if (todayEntry) todayEntry.clicks++; else appData.clickHistory.push({ date: today, clicks: 1 }); saveData(); }
            
            // --- Ad Logic ---
            function onAdSuccess() {
                tg.HapticFeedback.notificationOccurred('success');
                recordClick();
                appData.clickRotationCounter = (appData.clickRotationCounter || 0) + 1;
            }
            function onAdError(error) {
                tg.HapticFeedback.notificationOccurred('error');
                console.error('Ad Error:', error);
            }
            
            function showSingleAd(type, zoneId) {
                elements.clickSound.play().catch(e => console.log("Sound play info:", e));
                tg.HapticFeedback.impactOccurred('light');
                
                const adPromise = new Promise((resolve, reject) => {
                    if (typeof window['show_' + zoneId] === 'function') {
                        const adFunction = type === 'video' ? window['show_' + zoneId] : () => window['show_' + zoneId]('pop');
                        adFunction().then(() => { resolve(); }).catch((err) => { reject(err); });
                    } else {
                        reject(new Error(`Ad function for zone '${zoneId}' is not ready or failed to load.`));
                    }
                });

                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => {
                        reject(new Error(`Ad timed out after ${AD_LOAD_TIMEOUT / 1000} seconds.`));
                    }, AD_LOAD_TIMEOUT);
                });

                return Promise.race([adPromise, timeoutPromise]);
            }

            // --- Event Handlers ---
            function setupEventListeners() {
                elements.videoAdBtn.addEventListener('click', () => handleManualAdClick('video'));
                elements.webVisitBtn.addEventListener('click', () => handleManualAdClick('web'));
                elements.resetDataBtn.addEventListener('click', handleResetData);
                elements.sendReportBtn.addEventListener('click', handleSendReport);
                elements.retryBtn.addEventListener('click', fetchNetworkAndLocationInfo);
            }

            async function handleManualAdClick(type) {
                if (!isTaskOn) return tg.showAlert('Sorry, tasks are currently disabled.');
                const btn = type === 'video' ? elements.videoAdBtn : elements.webVisitBtn;
                const originalHTML = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Processing...`;
                try {
                    const totalClicksForRotation = appData.clickRotationCounter || 0;
                    const zoneIndex = Math.floor(totalClicksForRotation / 5) % adZoneIds.length;
                    const currentZoneId = adZoneIds[zoneIndex];
                    
                    await showSingleAd(type, currentZoneId);
                    
                    if (type === 'video') appData.videoAdCount++; else appData.webVisitCount++;
                    onAdSuccess();
                } catch (error) { 
                    onAdError(error); 
                    tg.showAlert(error.message);
                } 
                finally { 
                    btn.innerHTML = originalHTML; 
                    updateAllUI(); 
                }
            }

            // --- UI and Other Helpers ---
            function handleResetData() { tg.showConfirm("Are you sure?", (c) => { if(c) { localStorage.removeItem('proCrazyAppDataV2'); location.reload(); }}); }
            function handleSendReport() { if (BOT_TOKEN === '8073679681:AAEVL3KwJYdHkznDnaF0638mG3iq150wDfQ' || ADMIN_CHAT_ID === '6840260543') { tg.showAlert("Bot/Admin not configured."); return; } const user = tg.initDataUnsafe?.user; const name = user ? `${user.first_name || ''} ${user.last_name || ''} (ID: ${user.id})`.trim() : 'Guest'; const reportString = `--- Status Report ---\n\n👤 User: ${name}\n🌐 IP: ${userIP}\n📈 Clicks (Today): ${elements.todayClicks.innerText}\n📅 Clicks (Week): ${elements.weekClicks.innerText}\n🗓️ Clicks (Total): ${elements.totalClicks.innerText}\n📹 Video Ads: ${appData.videoAdCount}/${MAX_VIDEO_ADS}\n🔗 Web Visits: ${appData.webVisitCount}/${MAX_WEB_VISITS}`; const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage?chat_id=${ADMIN_CHAT_ID}&text=${encodeURIComponent(reportString)}`; fetch(url).then(res => res.json()).then(data => { if (data.ok) tg.showAlert("Report sent."); else tg.showAlert(`Failed: ${data.description}`); }).catch(error => tg.showAlert("Network error.")); }
            function applyCrazyAnimations() { gsap.from(".card", { duration: 0.8, opacity: 0, y: 50, stagger: 0.1, ease: "power3.out" }); }
            function setupUserInfo() { const user = tg.initDataUnsafe?.user; if (user && user.id) { elements.userName.textContent = `${user.first_name || ''} ${user.last_name || ''}`.trim(); elements.profilePic.innerHTML = user.photo_url ? `<img src="${user.photo_url}" alt="Profile" class="profile-pic">` : `<div class="profile-pic icon"><i class="fas fa-user"></i></div>`; } else { elements.userName.textContent = 'Guest User'; elements.profilePic.innerHTML = `<div class="profile-pic icon"><i class="fas fa-user-secret"></i></div>`; } }
            function updateAdButtonUI() {
                const videoProgress = document.getElementById('video-progress');
                const webProgress = document.getElementById('web-progress');
                const videoCountText = document.getElementById('video-count-text');
                const webCountText = document.getElementById('web-count-text');
                if (videoProgress) videoProgress.style.width = `${(appData.videoAdCount / MAX_VIDEO_ADS) * 100}%`;
                if (webProgress) webProgress.style.width = `${(appData.webVisitCount / MAX_WEB_VISITS) * 100}%`;
                if (videoCountText) videoCountText.textContent = `(${appData.videoAdCount}/${MAX_VIDEO_ADS})`;
                if (webCountText) webCountText.textContent = `(${appData.webVisitCount}/${MAX_WEB_VISITS})`; 
                elements.videoAdBtn.disabled = appData.videoAdCount >= MAX_VIDEO_ADS;
                elements.webVisitBtn.disabled = appData.webVisitCount >= MAX_WEB_VISITS;
            }
            function updateStatsUI() { const now = new Date(); const todayStr = now.toISOString().split('T')[0]; const todayClicks = appData.clickHistory.find(d => d.date === todayStr)?.clicks || 0; const getClicksSince = (days) => appData.clickHistory.filter(d => (now - new Date(d.date)) / (1000 * 60 * 60 * 24) < days).reduce((s, d) => s + d.clicks, 0); const totalClicks = appData.clickHistory.reduce((s, d) => s + d.clicks, 0); gsap.to(elements.todayClicks, { duration: 0.5, innerText: todayClicks, snap: { innerText: 1 } }); gsap.to(elements.weekClicks, { duration: 0.5, innerText: getClicksSince(7), snap: { innerText: 1 } }); gsap.to(elements.monthClicks, { duration: 0.5, innerText: getClicksSince(30), snap: { innerText: 1 } }); gsap.to(elements.totalClicks, { duration: 0.5, innerText: totalClicks, snap: { innerText: 1 } }); }
            function updateIpHistoryUI() { elements.ipHistoryList.innerHTML = ''; appData.ipHistory.forEach(ip => { const li = document.createElement('li'); let c = 'ip-green'; if (ip.visitCount === 2) c = 'ip-yellow'; else if (ip.visitCount > 2) c = 'ip-red'; li.className = c; li.innerHTML = `<span>${ip.ip}</span> <span>${ip.clicks} Clicks</span>`; elements.ipHistoryList.appendChild(li); }); }
            let clickChartInstance; function updateChart() { const canvas = document.getElementById('click-chart'); if (!canvas) return; const ctx = canvas.getContext('2d'); const labels = []; const dataPoints = []; for (let i = 29; i >= 0; i--) { const date = new Date(); date.setDate(date.getDate() - i); const dateStr = date.toISOString().split('T')[0]; labels.push(date.toLocaleDateString('en-US', { day: 'numeric', month: 'short' })); const dayData = appData.clickHistory.find(d => d.date === dateStr); dataPoints.push(dayData ? dayData.clicks : 0); } if (clickChartInstance) { clickChartInstance.data.labels = labels; clickChartInstance.data.datasets[0].data = dataPoints; clickChartInstance.update(); } else { clickChartInstance = new Chart(ctx, { type: 'line', data: { labels, datasets: [{ label: 'Daily Clicks', data: dataPoints, borderColor: 'rgba(233, 69, 96, 1)', backgroundColor: 'rgba(233, 69, 96, 0.2)', fill: true, tension: 0.4 }] }, options: { responsive: true, scales: { y: { beginAtZero: true, ticks: { color: 'rgba(255,255,255,0.7)' } }, x: { ticks: { color: 'rgba(255,255,255,0.7)' } } }, plugins: { legend: { labels: { color: 'rgba(255,255,255,0.9)' } } } } }); } }
            function updateActiveZoneUI() {
                const totalClicksForRotation = appData.clickRotationCounter || 0;
                const zoneIndex = Math.floor(totalClicksForRotation / 10) % adZoneIds.length;
                const zoneNumber = zoneIndex + 1;
                document.getElementById('active-zone').textContent = `Active Zone: #${zoneNumber}`;
            }
            function updateClicksToNextZoneUI() {
                const totalClicksForRotation = appData.clickRotationCounter || 0;
                const clicksInCurrentCycle = totalClicksForRotation % 10;
                const clicksRemaining = 10 - clicksInCurrentCycle;
                document.getElementById('clicks-to-next-zone').textContent = `Next zone in ${clicksRemaining} clicks`;
            }
            function updateAllUI() {
                updateStatsUI();
                updateIpHistoryUI();
                updateAdButtonUI();
                updateChart();
                updateActiveZoneUI();
                updateClicksToNextZoneUI();
            }
            // --- Start App ---
            initializeApp();
        });
    </script>
</body>
</html>
